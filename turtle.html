<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Code Cadets Turtle</title>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>

  <style>
    body { margin:0; padding:14px; font-family:system-ui; }
    h3 { margin:0 0 12px 0; }

    #layout {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 14px;
    }

    @media (max-width: 900px) {
      #layout { grid-template-columns: 1fr; }
      canvas { width: 100%; height: auto; }
    }

    /* =============================
       CodeMirror – ebook-matching
       ============================= */

    .CodeMirror {
      height: 280px;
      border-radius: 12px;
      border: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 14px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
    }

    .cm-s-ccbook.CodeMirror {
      background: #2b2f3a;
      color: #e9eef7;
    }

    .cm-s-ccbook .CodeMirror-lines { padding: 10px 0; }
    .cm-s-ccbook .CodeMirror-line { padding: 0 10px; }

    /* FIX: cursor + line spacing */
    .cm-s-ccbook .CodeMirror-line,
    .cm-s-ccbook .CodeMirror pre {
      line-height: 1.35;
    }

    .cm-s-ccbook .CodeMirror-cursor {
      border-left: 2px solid #ffffff !important;
      height: 1.35em !important;
    }

    .cm-s-ccbook .CodeMirror-selected {
      background: rgba(255,255,255,0.10) !important;
    }

    /* Gutter + line numbers */
    .cm-s-ccbook .CodeMirror-gutters {
      background: #262a34;
      border-right: 0;
    }

    .cm-s-ccbook .CodeMirror-linenumber {
      color: #7fd0c1;
      opacity: 0.75;
    }

    /* Syntax colours */
    .cm-s-ccbook .cm-keyword { color: #ff4fd8; }
    .cm-s-ccbook .cm-variable { color: #e9eef7; }
    .cm-s-ccbook .cm-builtin { color: #cbd5e1; }
    .cm-s-ccbook .cm-string  { color: #bfe8ff; }
    .cm-s-ccbook .cm-number  { color: #ffd479; }
    .cm-s-ccbook .cm-comment { color: #a7b0c0; opacity: 0.75; }

    /* =============================
       Rest of UI
       ============================= */

    canvas {
      background:#fff;
      border:1px solid #ccc;
      border-radius:10px;
    }

    button {
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #333;
      background:#111;
      color:#fff;
      cursor:pointer;
    }

    button.secondary {
      border:1px solid #999;
      background:#fff;
      color:#111;
    }

    button:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }

    #toolbar {
      display:flex;
      gap:10px;
      margin:10px 0;
      flex-wrap:wrap;
      align-items:center;
    }

    #status { font-size:14px; }

    .panelTitle {
      font-size:12px;
      margin:10px 0 6px 0;
      color:#374151;
    }

    pre {
      white-space: pre-wrap;
      background:#ffffff;
      color:#111;
      padding:10px;
      border-radius:10px;
      margin:0;
      min-height:90px;
      border:1px solid #d1d5db;
    }

    pre.err {
      background:#fff6f6;
      color:#7f1d1d;
      border:1px solid #f0c0c0;
    }
  </style>
</head>

<body>
  <h3>Code Cadets – Python Turtle</h3>

  <div id="layout">
    <div>
      <textarea id="code" spellcheck="false">from turtle import *</textarea>

      <div id="toolbar">
        <button id="run" disabled>Run</button>
        <button id="toggleLines" class="secondary" disabled>Line numbers: ON</button>
        <button id="clearCanvas" class="secondary">Clear canvas</button>
        <button id="clearOut" class="secondary">Clear output</button>
        <span id="status">Loading Python…</span>
      </div>

      <div class="panelTitle">Output</div>
      <pre id="out"></pre>

      <div class="panelTitle">Errors</div>
      <pre id="err" class="err"></pre>
    </div>

    <canvas id="canvas" width="520" height="520"></canvas>
  </div>

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const statusEl = document.getElementById("status");
  const outEl = document.getElementById("out");
  const errEl = document.getElementById("err");

  const runBtn = document.getElementById("run");
  const toggleLinesBtn = document.getElementById("toggleLines");
  const clearCanvasBtn = document.getElementById("clearCanvas");
  const clearOutBtn = document.getElementById("clearOut");

  /* ---------- CodeMirror ---------- */
  const editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    mode: "python",
    theme: "ccbook",
    lineNumbers: true,
    indentUnit: 2,
    tabSize: 2,
    viewportMargin: Infinity
  });

  editor.getWrapperElement().classList.add("cm-s-ccbook");

  let linesOn = true;
  toggleLinesBtn.onclick = () => {
    linesOn = !linesOn;
    editor.setOption("lineNumbers", linesOn);
    toggleLinesBtn.textContent = `Line numbers: ${linesOn ? "ON" : "OFF"}`;
    editor.refresh();
  };

  clearOutBtn.onclick = () => { outEl.textContent = ""; errEl.textContent = ""; };

  /* ---------- Turtle engine ---------- */

  const cx = () => canvas.width / 2;
  const cy = () => canvas.height / 2;

  let x, y, angle, penDown, penColor, fillColor, penSize, isFilling;
  let bgColor = "#ffffff";
  let delayMs = 10;
  let tracerN = 1;
  let tracerDelayMs = null;
  let queue = [];

  function resetTurtle() {
    x = cx(); y = cy(); angle = 0;
    penDown = true;
    penColor = "#000";
    fillColor = "#000";
    penSize = 2;
    isFilling = false;
    queue = [];
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = bgColor;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  function q(type, value){ queue.push([type,value]); }

  function forward(d){ q("f", d); }
  function left(a){ q("l", a); }

  async function runQueue(){
    for (const [t,v] of queue){
      if (t === "f"){
        const steps = Math.max(1, Math.abs(v));
        for (let i=0;i<steps;i++){
          const rad = angle*Math.PI/180;
          const nx = x + Math.cos(rad);
          const ny = y - Math.sin(rad);
          ctx.beginPath();
          ctx.moveTo(x,y);
          ctx.lineTo(nx,ny);
          ctx.stroke();
          x=nx;y=ny;
          await new Promise(r=>setTimeout(r,delayMs));
        }
      }
      if (t === "l"){ angle += v; }
    }
  }

  /* ---------- Pyodide ---------- */

  let pyodide;

  async function main(){
    pyodide = await loadPyodide();
    runBtn.disabled = false;
    toggleLinesBtn.disabled = false;
    statusEl.textContent = "Ready";
  }

  runBtn.onclick = async () => {
    resetTurtle();
    try {
      await pyodide.runPythonAsync(editor.getValue());
      await runQueue();
      statusEl.textContent = "Done";
    } catch (e) {
      errEl.textContent = e.toString();
      statusEl.textContent = "Error";
    }
  };

  resetTurtle();
  main();
</script>
</body>
</html>
