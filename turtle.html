<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Code Cadets Turtle</title>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

  <style>
    body { margin:0; padding:14px; font-family:system-ui; }
    #layout { display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
    textarea {
      width:100%;
      height:280px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:14px;
      padding:10px;
      border:1px solid #ccc;
      border-radius:10px;
      box-sizing:border-box;
    }
    canvas { background:#fff; border:1px solid #ccc; border-radius:10px; }
    button {
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #333;
      background:#111;
      color:#fff;
      cursor:pointer;
    }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    #toolbar { display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; align-items:center; }
    #status { font-size:14px; }
  </style>
</head>

<body>
  <h3 style="margin:0 0 12px 0;">Code Cadets - Python Turtle</h3>

  <div id="layout">
    <div>
      <textarea id="code" spellcheck="false">import turtle

turtle.forward(100)
turtle.left(90)
turtle.forward(100)
</textarea>

      <div id="toolbar">
        <button id="run" disabled>Run</button>
        <button id="clear">Clear</button>
        <span id="status">Loading Python…</span>
      </div>

      <pre id="err" style="white-space:pre-wrap; background:#f6f6f6; border:1px solid #ddd; padding:10px; border-radius:10px; margin:0; min-height:70px;"></pre>
    </div>

    <canvas id="canvas" width="420" height="420"></canvas>
  </div>

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const statusEl = document.getElementById("status");
  const errEl = document.getElementById("err");
  const runBtn = document.getElementById("run");
  const clearBtn = document.getElementById("clear");
  const codeEl = document.getElementById("code");

  ctx.lineWidth = 2;

  // Turtle state
  let x, y, angle, penDown;

  function resetTurtle() {
    x = canvas.width / 2;
    y = canvas.height / 2;
    angle = 0;
    penDown = true;
  }

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    resetTurtle();
  }

  // Option B: queue commands so pupil code stays the same (no await)
  let queue = [];
  let delayMs = 10; // smaller = faster

  function forward(dist) { queue.push(["forward", Number(dist) || 0]); }
  function left(deg) { queue.push(["left", Number(deg) || 0]); }
  function right(deg) { queue.push(["right", Number(deg) || 0]); }
  function penup() { queue.push(["penup"]); }
  function pendown() { queue.push(["pendown"]); }

  async function runQueue() {
    for (const cmd of queue) {
      const type = cmd[0];
      const value = cmd[1];

      if (type === "left") { angle += value; continue; }
      if (type === "right") { angle -= value; continue; }
      if (type === "penup") { penDown = false; continue; }
      if (type === "pendown") { penDown = true; continue; }

      if (type === "forward") {
        const dist = value;
        const steps = Math.max(1, Math.min(2000, Math.round(Math.abs(dist))));
        const stepSize = dist / steps;

        for (let i = 0; i < steps; i++) {
          const rad = angle * Math.PI / 180;
          const nx = x + Math.cos(rad) * stepSize;
          const ny = y - Math.sin(rad) * stepSize;

          if (penDown) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(nx, ny);
            ctx.stroke();
          }

          x = nx; y = ny;
          await new Promise(r => setTimeout(r, delayMs));
        }
      }
    }
    queue = [];
  }

  let pyodide = null;

  async function main() {
    try {
      pyodide = await loadPyodide();

      // Register under a safe name
      pyodide.registerJsModule("cc_turtle", { forward, left, right, penup, pendown });

      runBtn.disabled = false;
      statusEl.textContent = "Ready";
    } catch (err) {
      statusEl.textContent = "Failed to load Python";
      errEl.textContent = String(err);
      console.error(err);
    }
  }

  clearBtn.onclick = () => {
    clearCanvas();
    queue = [];
    errEl.textContent = "";
    statusEl.textContent = "Ready";
  };

  runBtn.onclick = async () => {
    statusEl.textContent = "Running…";
    errEl.textContent = "";

    try {
      clearCanvas();
      queue = [];

      // Force "import turtle" to use our cc_turtle module
      pyodide.runPython(`
import sys, importlib
sys.modules["turtle"] = importlib.import_module("cc_turtle")
      `.trim());

      // Run pupil code (fills queue)
      await pyodide.runPythonAsync(codeEl.value);

      // Animate after Python finishes
      statusEl.textContent = "Drawing…";
      await runQueue();

      statusEl.textContent = "Done";
    } catch (err) {
      statusEl.textContent = "Error";
      errEl.textContent = String(err);
      console.error(err);
    }
  };

  clearCanvas();
  main();
</script>
</body>
</html>
